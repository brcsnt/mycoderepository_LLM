
import streamlit as st
import logging
from langchain.chat_models import ChatOpenAI
from langchain.chains import RetrievalQA
from langchain.memory import ConversationBufferMemory
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Chroma
from langchain.docstore.document import Document
import os
import re

# 1ï¸âƒ£ Logger Ayarla
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# 2ï¸âƒ£ API AnahtarÄ± TanÄ±mla
os.environ["OPENAI_API_KEY"] = "your_api_key_here"

# 3ï¸âƒ£ Ã–rnek Kampanya Verileri
campaigns = [
    {"code": "KAMP001", "title": "Migros Ä°ndirim KampanyasÄ±", "content": "Migros marketlerinde %20 indirim! 1-10 Åubat arasÄ±nda geÃ§erlidir.", "start_date": "01-02-2024", "end_date": "10-02-2024"},
    {"code": "KAMP002", "title": "Beyaz EÅŸya KampanyasÄ±", "content": "Beyaz eÅŸyalar 15 Mart'a kadar Ã¶zel fiyatlarla!", "start_date": "01-03-2024", "end_date": "15-03-2024"},
    {"code": "KAMP003", "title": "Giyim Sezon Sonu Ä°ndirimi", "content": "TÃ¼m giyim Ã¼rÃ¼nlerinde %30 indirim!", "start_date": "01-04-2024", "end_date": "30-04-2024"}
   
]

# 4ï¸âƒ£ OpenAI Embeddings kullanarak ChromaDB oluÅŸtur ve doldur
embeddings = OpenAIEmbeddings()
vector_store = Chroma(embedding_function=embeddings)

# Kampanya verilerini ChromaDB'ye ekleyelim
docs = [Document(page_content=f"{c['title']}: {c['content']} (GeÃ§erlilik: {c['start_date']} - {c['end_date']})", metadata={"code": c["code"]}) for c in campaigns]
vector_store.add_documents(docs)
retriever = vector_store.as_retriever(search_kwargs={"k": 3})

# 5ï¸âƒ£ LLM Modeli TanÄ±mla ve Sistem Prompt Ekle
system_prompt = "Sen bir reklam kampanya asistanÄ±sÄ±n. KullanÄ±cÄ±ya kampanyalar hakkÄ±nda bilgi ver, ama sadece kampanya metinlerinden referans al."
llm = ChatOpenAI(model_name="gpt-4", temperature=0, system_prompt=system_prompt)
qa_chain = RetrievalQA.from_chain_type(llm=llm, retriever=retriever)

# 6ï¸âƒ£ Sohbet HafÄ±zasÄ±nÄ± (Memory) TanÄ±mla
memory = ConversationBufferMemory(memory_key="chat_history", return_messages=True)
previous_retrieved_campaigns = {}
follow_up_count = 0
max_follow_up = 5  # KullanÄ±cÄ±nÄ±n aynÄ± kampanya iÃ§inde sorabileceÄŸi maksimum takip sorusu

# 7ï¸âƒ£ Kampanya Kodunu Ã‡Ä±kart ve DoÄŸrudan Bilgi Getir
def extract_campaign_code(user_input):
    try:
        match = re.search(r"KAMP\d{3}", user_input)
        return match.group(0) if match else None
    except Exception as e:
        logger.error(f"Kampanya kodu Ã§Ä±karma hatasÄ±: {e}")
        return None

# 8ï¸âƒ£ Yeni Kampanyaya GeÃ§iÅŸi AlgÄ±la
def detect_new_campaign(user_input):
    global previous_retrieved_campaigns, follow_up_count
    
    try:
        logger.info(f"Yeni kampanya tespiti iÃ§in giriÅŸ alÄ±ndÄ±: {user_input}")
        
        campaign_code = extract_campaign_code(user_input)
        if campaign_code:
            docs = retriever.get_relevant_documents(campaign_code)
            if docs:
                previous_retrieved_campaigns[campaign_code] = docs[0]
                follow_up_count = 0  # Yeni kampanya baÅŸladÄ±ÄŸÄ±nda follow-up sayacÄ±nÄ± sÄ±fÄ±rla
                logger.info(f"Belirtilen kampanya kodu bulundu: {campaign_code}, Ä°Ã§erik: {docs[0].page_content}")
                return docs[0].page_content
        
        # VectorStore kullanarak en alakalÄ± top_n kampanyayÄ± bul
        similar_docs = retriever.get_relevant_documents(user_input)
        if similar_docs:
            previous_retrieved_campaigns = {f"KAMP{i+1:03}": doc for i, doc in enumerate(similar_docs)}
            follow_up_count = 0  # Yeni kampanya bulunduÄŸunda follow-up sÄ±fÄ±rlanÄ±r
            result = "\n".join([f"{key} - {doc.page_content.split(' ', 5)[0]}..." for key, doc in previous_retrieved_campaigns.items()])
            return f"En alakalÄ± kampanyalar:\n{result}"
        
        return "Uygun kampanya bulunamadÄ±."
    except Exception as e:
        logger.error(f"Yeni kampanya tespitinde hata: {e}")
        return "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."

# 9ï¸âƒ£ KullanÄ±cÄ±dan GiriÅŸ Al ve YanÄ±t DÃ¶ndÃ¼r
def chat_with_bot(user_input):
    global previous_retrieved_campaigns, follow_up_count
    
    try:
        logger.info(f"KullanÄ±cÄ± giriÅŸi: {user_input}")
        
        if follow_up_count >= max_follow_up:
            return "âš  Maksimum takip soru sÄ±nÄ±rÄ±na ulaÅŸÄ±ldÄ±. Yeni bir kampanya hakkÄ±nda soru sorabilirsiniz."
        
        chat_history = memory.load_memory_variables({})["chat_history"]
        campaign_info = detect_new_campaign(user_input)
        if campaign_info:
            return campaign_info
        
        match = re.search(r"(KAMP\d{3}) hakkÄ±nda (.+)\??", user_input)
        if match:
            campaign_code = match.group(1)
            if campaign_code in previous_retrieved_campaigns:
                selected_campaign = previous_retrieved_campaigns[campaign_code]
                follow_up_count += 1  # Takip sorusu sayÄ±sÄ±nÄ± artÄ±r
                logger.info(f"SeÃ§ilen kampanya: {selected_campaign}")
                return qa_chain.run(f"{chat_history}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {selected_campaign.page_content}")
            return "âš  GeÃ§ersiz kampanya kodu. LÃ¼tfen geÃ§erli bir kampanya girin."
        
        follow_up_count += 1  # Genel sorular iÃ§in de takip sorusu sayÄ±sÄ±nÄ± artÄ±r
        response = qa_chain.run(f"{chat_history}\nKullanÄ±cÄ±: {user_input}")
        memory.save_context({"input": user_input}, {"output": response})
        logger.info(f"LLM YanÄ±tÄ±: {response}")
        return response
    except Exception as e:
        logger.error(f"Chat iÅŸleminde hata: {e}")
        return "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."

# ğŸ”Ÿ Streamlit ArayÃ¼zÃ¼
st.title("ğŸ“¢ Reklam Kampanya Chatbotu")
st.write("SorularÄ±nÄ±zÄ± sorun, kampanyalar hakkÄ±nda bilgi alÄ±n!")

user_input = st.text_input("MesajÄ±nÄ±zÄ± girin:")
if st.button("GÃ¶nder"):
    if user_input:
        response = chat_with_bot(user_input)
        st.write(response)
