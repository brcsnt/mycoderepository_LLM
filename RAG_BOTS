
import streamlit as st
import logging
from langchain.chat_models import ChatOpenAI
from langchain.chains import RetrievalQA
from langchain.memory import ConversationBufferMemory
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Chroma
from langchain.docstore.document import Document
import os
import re

# 1ï¸âƒ£ Logger Ayarla
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# 2ï¸âƒ£ API AnahtarÄ± TanÄ±mla
os.environ["OPENAI_API_KEY"] = "your_api_key_here"

# 3ï¸âƒ£ Ã–rnek Kampanya Verileri
campaigns = [
    {"code": "KAMP001", "title": "Migros Ä°ndirim KampanyasÄ±", "content": "Migros marketlerinde %20 indirim! 1-10 Åubat arasÄ±nda geÃ§erlidir.", "start_date": "01-02-2024", "end_date": "10-02-2024"},
    {"code": "KAMP002", "title": "Beyaz EÅŸya KampanyasÄ±", "content": "Beyaz eÅŸyalar 15 Mart'a kadar Ã¶zel fiyatlarla!", "start_date": "01-03-2024", "end_date": "15-03-2024"},
    {"code": "KAMP003", "title": "Giyim Sezon Sonu Ä°ndirimi", "content": "TÃ¼m giyim Ã¼rÃ¼nlerinde %30 indirim!", "start_date": "01-04-2024", "end_date": "30-04-2024"}
   
]

# 4ï¸âƒ£ OpenAI Embeddings kullanarak ChromaDB oluÅŸtur ve doldur
embeddings = OpenAIEmbeddings()
vector_store = Chroma(embedding_function=embeddings)

# Kampanya verilerini ChromaDB'ye ekleyelim
docs = [Document(page_content=f"{c['title']}: {c['content']} (GeÃ§erlilik: {c['start_date']} - {c['end_date']})", metadata={"code": c["code"]}) for c in campaigns]
vector_store.add_documents(docs)
retriever = vector_store.as_retriever(search_kwargs={"k": 3})

# 5ï¸âƒ£ LLM Modeli TanÄ±mla ve Sistem Prompt Ekle
system_prompt = "Sen bir reklam kampanya asistanÄ±sÄ±n. KullanÄ±cÄ±ya kampanyalar hakkÄ±nda bilgi ver, ama sadece kampanya metinlerinden referans al."
llm = ChatOpenAI(model_name="gpt-4", temperature=0, system_prompt=system_prompt)
qa_chain = RetrievalQA.from_chain_type(llm=llm, retriever=retriever)

# 6ï¸âƒ£ Sohbet HafÄ±zasÄ±nÄ± (Memory) TanÄ±mla
memory = ConversationBufferMemory(memory_key="chat_history", return_messages=True)
previous_retrieved_campaigns = {}
follow_up_count = 0
max_follow_up = 5  # KullanÄ±cÄ±nÄ±n aynÄ± kampanya iÃ§inde sorabileceÄŸi maksimum takip sorusu

# 7ï¸âƒ£ Kampanya Kodunu Ã‡Ä±kart ve DoÄŸrudan Bilgi Getir
def extract_campaign_code(user_input):
    try:
        match = re.search(r"KAMP\d{3}", user_input)
        return match.group(0) if match else None
    except Exception as e:
        logger.error(f"Kampanya kodu Ã§Ä±karma hatasÄ±: {e}")
        return None

# 8ï¸âƒ£ Yeni Kampanyaya GeÃ§iÅŸi AlgÄ±la
def detect_new_campaign(user_input):
    global previous_retrieved_campaigns, follow_up_count
    
    try:
        logger.info(f"Yeni kampanya tespiti iÃ§in giriÅŸ alÄ±ndÄ±: {user_input}")
        
        campaign_code = extract_campaign_code(user_input)
        if campaign_code:
            docs = retriever.get_relevant_documents(campaign_code)
            if docs:
                previous_retrieved_campaigns[campaign_code] = docs[0]
                follow_up_count = 0  # Yeni kampanya baÅŸladÄ±ÄŸÄ±nda follow-up sayacÄ±nÄ± sÄ±fÄ±rla
                logger.info(f"Belirtilen kampanya kodu bulundu: {campaign_code}, Ä°Ã§erik: {docs[0].page_content}")
                return docs[0].page_content
        
        # VectorStore kullanarak en alakalÄ± top_n kampanyayÄ± bul
        similar_docs = retriever.get_relevant_documents(user_input)
        if similar_docs:
            previous_retrieved_campaigns = {f"KAMP{i+1:03}": doc for i, doc in enumerate(similar_docs)}
            follow_up_count = 0  # Yeni kampanya bulunduÄŸunda follow-up sÄ±fÄ±rlanÄ±r
            result = "\n".join([f"{key} - {doc.page_content.split(' ', 5)[0]}..." for key, doc in previous_retrieved_campaigns.items()])
            return f"En alakalÄ± kampanyalar:\n{result}"
        
        return "Uygun kampanya bulunamadÄ±."
    except Exception as e:
        logger.error(f"Yeni kampanya tespitinde hata: {e}")
        return "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."

# 9ï¸âƒ£ KullanÄ±cÄ±dan GiriÅŸ Al ve YanÄ±t DÃ¶ndÃ¼r
def chat_with_bot(user_input):
    global previous_retrieved_campaigns, follow_up_count
    
    try:
        logger.info(f"KullanÄ±cÄ± giriÅŸi: {user_input}")
        
        if follow_up_count >= max_follow_up:
            return "âš  Maksimum takip soru sÄ±nÄ±rÄ±na ulaÅŸÄ±ldÄ±. Yeni bir kampanya hakkÄ±nda soru sorabilirsiniz."
        
        chat_history = memory.load_memory_variables({})["chat_history"]
        campaign_info = detect_new_campaign(user_input)
        if campaign_info:
            return campaign_info
        
        match = re.search(r"(KAMP\d{3}) hakkÄ±nda (.+)\??", user_input)
        if match:
            campaign_code = match.group(1)
            if campaign_code in previous_retrieved_campaigns:
                selected_campaign = previous_retrieved_campaigns[campaign_code]
                follow_up_count += 1  # Takip sorusu sayÄ±sÄ±nÄ± artÄ±r
                logger.info(f"SeÃ§ilen kampanya: {selected_campaign}")
                return qa_chain.run(f"{chat_history}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {selected_campaign.page_content}")
            return "âš  GeÃ§ersiz kampanya kodu. LÃ¼tfen geÃ§erli bir kampanya girin."
        
        follow_up_count += 1  # Genel sorular iÃ§in de takip sorusu sayÄ±sÄ±nÄ± artÄ±r
        response = qa_chain.run(f"{chat_history}\nKullanÄ±cÄ±: {user_input}")
        memory.save_context({"input": user_input}, {"output": response})
        logger.info(f"LLM YanÄ±tÄ±: {response}")
        return response
    except Exception as e:
        logger.error(f"Chat iÅŸleminde hata: {e}")
        return "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."

# ğŸ”Ÿ Streamlit ArayÃ¼zÃ¼
st.title("ğŸ“¢ Reklam Kampanya Chatbotu")
st.write("SorularÄ±nÄ±zÄ± sorun, kampanyalar hakkÄ±nda bilgi alÄ±n!")

user_input = st.text_input("MesajÄ±nÄ±zÄ± girin:")
if st.button("GÃ¶nder"):
    if user_input:
        response = chat_with_bot(user_input)
        st.write(response)



---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------





import streamlit as st
import logging
from langchain.chat_models import ChatOpenAI
from langchain.chains import RetrievalQA
from langchain.memory import ConversationBufferMemory
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Chroma
from langchain.docstore.document import Document
import os
import re

# 1ï¸âƒ£ Logger Ayarla - Hata ve iÅŸlem kayÄ±tlarÄ±nÄ± tutmak iÃ§in kullanÄ±lÄ±r
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# 2ï¸âƒ£ OpenAI API AnahtarÄ± TanÄ±mla - OpenAI LLM modelini kullanabilmek iÃ§in gerekli
os.environ["OPENAI_API_KEY"] = "your_api_key_here"

# 3ï¸âƒ£ Ã–rnek Kampanya Verileri - KullanÄ±cÄ±ya sunulacak kampanyalar burada tanÄ±mlanÄ±r
campaigns = [
    {"code": "KAMP001", "title": "Migros Ä°ndirim KampanyasÄ±", "content": "Migros marketlerinde %20 indirim! 1-10 Åubat arasÄ±nda geÃ§erlidir.", "start_date": "01-02-2024", "end_date": "10-02-2024"},
    {"code": "KAMP002", "title": "Beyaz EÅŸya KampanyasÄ±", "content": "Beyaz eÅŸyalar 15 Mart'a kadar Ã¶zel fiyatlarla!", "start_date": "01-03-2024", "end_date": "15-03-2024"},
    {"code": "KAMP003", "title": "Giyim Sezon Sonu Ä°ndirimi", "content": "TÃ¼m giyim Ã¼rÃ¼nlerinde %30 indirim!", "start_date": "01-04-2024", "end_date": "30-04-2024"}
]

# 4ï¸âƒ£ OpenAI Embeddings kullanarak ChromaDB oluÅŸtur ve doldur - Kampanyalar vektÃ¶r olarak saklanÄ±r
embeddings = OpenAIEmbeddings()
vector_store = Chroma(embedding_function=embeddings)

# Kampanya verilerini ChromaDB'ye ekleyelim
docs = [Document(page_content=f"{c['title']}: {c['content']} (GeÃ§erlilik: {c['start_date']} - {c['end_date']})", metadata={"code": c["code"]}) for c in campaigns]
vector_store.add_documents(docs)
retriever = vector_store.as_retriever(search_kwargs={"k": 3})

# 5ï¸âƒ£ LLM Modeli TanÄ±mla ve Sistem Prompt Ekle - Modelin nasÄ±l davranacaÄŸÄ±nÄ± belirler
system_prompt = "Sen bir reklam kampanya asistanÄ±sÄ±n. KullanÄ±cÄ±ya kampanyalar hakkÄ±nda bilgi ver, ama sadece kampanya metinlerinden referans al."
follow_up_prompt = "Bu bir takip sorusudur. Ã–nceki konuÅŸmalarÄ± dikkate alarak, sadece kampanya metinlerine dayanarak kesin ve kÄ±sa bir yanÄ±t ver."

llm = ChatOpenAI(model_name="gpt-4", temperature=0, system_prompt=system_prompt)
qa_chain = RetrievalQA.from_chain_type(llm=llm, retriever=retriever)

# 6ï¸âƒ£ Sohbet HafÄ±zasÄ±nÄ± (Memory) TanÄ±mla - KullanÄ±cÄ±nÄ±n konuÅŸmalarÄ±nÄ± saklar
memory = ConversationBufferMemory(memory_key="chat_history", return_messages=True)
previous_retrieved_campaigns = {}  # Ã–nceki getirilen kampanyalarÄ± saklar
follow_up_count = 0  # KullanÄ±cÄ±nÄ±n kaÃ§ tane takip sorusu sorduÄŸunu takip eder
max_follow_up = 5  # KullanÄ±cÄ±nÄ±n aynÄ± kampanya iÃ§inde sorabileceÄŸi maksimum takip sorusu

# 9ï¸âƒ£ KullanÄ±cÄ±dan GiriÅŸ Al ve YanÄ±t DÃ¶ndÃ¼r - KullanÄ±cÄ±nÄ±n mesajÄ±nÄ± alÄ±r ve uygun cevabÄ± dÃ¶ndÃ¼rÃ¼r
def chat_with_bot(user_input):
    global previous_retrieved_campaigns, follow_up_count
    
    try:
        logger.info(f"KullanÄ±cÄ± giriÅŸi: {user_input}")
        
        if follow_up_count >= max_follow_up:
            return "âš  Maksimum takip soru sÄ±nÄ±rÄ±na ulaÅŸÄ±ldÄ±. Yeni bir kampanya hakkÄ±nda soru sorabilirsiniz."
        
        chat_history = memory.load_memory_variables({})["chat_history"]
        campaign_info = detect_new_campaign(user_input)
        if campaign_info:
            return campaign_info
        
        match = re.search(r"(KAMP\d{3}) hakkÄ±nda (.+)\??", user_input)
        if match:
            campaign_code = match.group(1)
            if campaign_code in previous_retrieved_campaigns:
                selected_campaign = previous_retrieved_campaigns[campaign_code]
                follow_up_count += 1
                logger.info(f"SeÃ§ilen kampanya: {selected_campaign}")
                return qa_chain.run(f"{follow_up_prompt}\n{chat_history}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {selected_campaign.page_content}")
        
        follow_up_count += 1
        if follow_up_count > 1:
            response = qa_chain.run(f"{follow_up_prompt}\n{chat_history}\nKullanÄ±cÄ±: {user_input}")
        else:
            response = qa_chain.run(f"{system_prompt}\n{chat_history}\nKullanÄ±cÄ±: {user_input}")
        
        memory.save_context({"input": user_input}, {"output": response})
        logger.info(f"LLM YanÄ±tÄ±: {response}")
        return response
    except Exception as e:
        logger.error(f"Chat iÅŸleminde hata: {e}")
        return "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."

# ğŸ”Ÿ Streamlit ArayÃ¼zÃ¼ - KullanÄ±cÄ±dan giriÅŸ alÄ±p chatbot ile iletiÅŸime geÃ§mesini saÄŸlar
st.title("ğŸ“¢ Reklam Kampanya Chatbotu")
st.write("SorularÄ±nÄ±zÄ± sorun, kampanyalar hakkÄ±nda bilgi alÄ±n!")

user_input = st.text_input("MesajÄ±nÄ±zÄ± girin:")
if st.button("GÃ¶nder"):
    if user_input:
        response = chat_with_bot(user_input)
        st.write(response)



------------------------------------------------------------------------------------------------------------------------------------------------



"""


Evet, kodun son hali yukarÄ±daki diyalog akÄ±ÅŸÄ±na uygun ÅŸekilde cevap verebilecek ÅŸekilde tasarlanmÄ±ÅŸtÄ±r. Ã–rneÄŸin:

KullanÄ±cÄ±: "KAMP001 kampanyasÄ± nedir ?"

Sorguda aÃ§Ä±kÃ§a "KAMP001" yer aldÄ±ÄŸÄ±ndan, sistem doÄŸrudan bu kampanyayÄ± tespit eder, global kampanya listesi ve takip sayacÄ± sÄ±fÄ±rlanÄ±r (konuÅŸma geÃ§miÅŸi temizlenir) ve KAMP001â€™in iÃ§erik bilgisi ile LLMâ€™ye sorgu gÃ¶nderilerek yanÄ±t Ã¼retilir.
KullanÄ±cÄ±: "Bana Migros kampanyasÄ±nÄ±n detaylarÄ±nÄ± sÃ¶yle."

Sorguda aÃ§Ä±k bir kampanya kodu olmadÄ±ÄŸÄ± iÃ§in, sistem vector store Ã¼zerinden TOP_N (3) kriterine gÃ¶re ilgili kampanyalarÄ± arar. EÄŸer Migros ile ilgili kampanyalar varsa, bu kampanyalarÄ±n kod ve baÅŸlÄ±k bilgileri liste halinde (Ã¶rneÄŸin, â€œ1. KAMP001: Migros Ä°ndirim KampanyasÄ±â€ gibi) sunulur.
KullanÄ±cÄ±: "2.gelen kampanyanÄ±n iÃ§eriÄŸi nedir?"

Bu takip (follow-up) sorgusunda, sistem Ã¶nceki listelenen kampanyalar ve konuÅŸma geÃ§miÅŸini LLMâ€™ye gÃ¶ndererek kullanÄ±cÄ±nÄ±n hangi kampanyaya atÄ±fta bulunduÄŸunu belirlemesini ister. LLMâ€™nin tespit ettiÄŸi kampanyanÄ±n iÃ§erik bilgisi, kullanÄ±cÄ±nÄ±n sorusu ile birlikte LLMâ€™ye gÃ¶nderilir ve LLMâ€™nin cevabÄ± ekrana basÄ±lÄ±r.
KullanÄ±cÄ±: "Peki 3.sÄ±radaki kampanyanÄ±n detayÄ± neydi yazar mÄ±sÄ±n?"

AynÄ± ÅŸekilde, LLM Ã¶nceki listeden (Ã¶rneÄŸin, 3. sÄ±radaki kampanya) hangi kampanyanÄ±n kastedildiÄŸini belirler, ilgili kampanyanÄ±n iÃ§erik bilgisi ve kullanÄ±cÄ± sorusu ile LLMâ€™den nihai yanÄ±t alÄ±nÄ±r.
KullanÄ±cÄ±: "Peki sonuncu yazan kampanyanÄ±n detayÄ±?"

LLM, "sonuncu" ifadesini de gÃ¶z Ã¶nÃ¼nde bulundurarak Ã¶nceki listeden en son elemanÄ± tespit eder ve bu kampanyanÄ±n detaylarÄ±, kullanÄ±cÄ±nÄ±n sorusu ile birlikte LLMâ€™ye gÃ¶nderilerek yanÄ±t Ã¼retilir.
KullanÄ±cÄ±: "Beyaz eÅŸya kampanyasÄ±nÄ±n detaylarÄ± neydi peki"

EÄŸer LLM, bu sorgunun Ã¶nceki listelenen kampanyalarla iliÅŸkili olmadÄ±ÄŸÄ±nÄ± belirlerse, sistem global durumu (last_retrieved_campaigns ve konuÅŸma geÃ§miÅŸini) temizler ve yeni kampanya sorgusu olarak "Beyaz EÅŸya KampanyasÄ±"nÄ± vector storeâ€™dan arar. BÃ¶ylece yeni kampanya sorgusu Ã¼zerinden ilgili kampanyanÄ±n detaylarÄ± LLMâ€™den alÄ±nÄ±r.
KullanÄ±cÄ±: "KAMP003 kampanyasÄ±nÄ±n detaylarÄ± nedir ?"

Sorguda aÃ§Ä±kÃ§a "KAMP003" yer aldÄ±ÄŸÄ±ndan, sistem doÄŸrudan KAMP003â€™Ã¼ tespit eder, global durum sÄ±fÄ±rlanÄ±r ve KAMP003â€™Ã¼n iÃ§erik bilgisi ile LLMâ€™ye sorgu gÃ¶nderilerek yanÄ±t alÄ±nÄ±r.
AyrÄ±ca, takip sorgularÄ±nda maksimum takip sayÄ±sÄ± (Ã¶rneÄŸin MAX_FOLLOW_UP = 5) uygulanmakta; eÄŸer kullanÄ±cÄ± 5 takip sorgusuna ulaÅŸÄ±rsa, sistem otomatik olarak global durumu temizleyip yeni kampanya sorgusu yapÄ±lmasÄ±nÄ± isteyecektir.

Bu yapÄ± sayesinde, kullanÄ±cÄ± hiÃ§bir ek numeric veya sÄ±ralama girdisi vermeden, tamamen doÄŸal diyalog akÄ±ÅŸÄ± iÃ§erisinde doÄŸru kampanyanÄ±n tespit edilip, ilgili kampanyanÄ±n iÃ§erik bilgisiyle LLM tarafÄ±ndan Ã¼retilen yanÄ±t ekrana basÄ±lacaktÄ±r.


"""


import streamlit as st
import logging
import os
import re
from langchain.chat_models import ChatOpenAI
from langchain.chains import RetrievalQA
from langchain.memory import ConversationBufferMemory
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Chroma
from langchain.docstore.document import Document

# 1ï¸âƒ£ Logger Ayarla
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# 2ï¸âƒ£ OpenAI API AnahtarÄ± TanÄ±mla
os.environ["OPENAI_API_KEY"] = "your_api_key_here"  # API anahtarÄ±nÄ±zÄ± buraya girin

# 3ï¸âƒ£ Ã–rnek Kampanya Verileri
campaigns = [
    {"code": "KAMP001", "title": "Migros Ä°ndirim KampanyasÄ±", "content": "Migros marketlerinde %20 indirim! 1-10 Åubat arasÄ±nda geÃ§erlidir.", "start_date": "01-02-2024", "end_date": "10-02-2024"},
    {"code": "KAMP002", "title": "Beyaz EÅŸya KampanyasÄ±", "content": "Beyaz eÅŸyalar 15 Mart'a kadar Ã¶zel fiyatlarla!", "start_date": "01-03-2024", "end_date": "15-03-2024"},
    {"code": "KAMP003", "title": "Giyim Sezon Sonu Ä°ndirimi", "content": "TÃ¼m giyim Ã¼rÃ¼nlerinde %30 indirim!", "start_date": "01-04-2024", "end_date": "30-04-2024"}
]

# Parametrik olarak top_n deÄŸeri (ÅŸu anda 3 olarak ayarlandÄ±)
TOP_N = 3

# Takip sorgularÄ± iÃ§in maksimum sayÄ±yÄ± belirleyelim (Ã¶rneÄŸin, 5)
MAX_FOLLOW_UP = 5

# 4ï¸âƒ£ OpenAI Embeddings kullanarak ChromaDB oluÅŸtur ve doldur
embeddings = OpenAIEmbeddings()
vector_store = Chroma(embedding_function=embeddings)
docs = [
    Document(
        page_content=f"{c['title']}: {c['content']} (GeÃ§erlilik: {c['start_date']} - {c['end_date']})",
        metadata={"code": c["code"]}
    )
    for c in campaigns
]
vector_store.add_documents(docs)
# TOP_N kriteri kullanÄ±larak en iyi sonuÃ§lar alÄ±nÄ±r.
retriever = vector_store.as_retriever(search_kwargs={"k": TOP_N})

# 5ï¸âƒ£ LLM Modeli ve Prompt AyarlarÄ±
system_prompt = "Sen bir reklam kampanya asistanÄ±sÄ±n. KullanÄ±cÄ±ya kampanyalar hakkÄ±nda bilgi ver, yanÄ±tlarÄ±nÄ± sadece kampanya metinlerine dayandÄ±r."
follow_up_prompt = (
    "Bu bir takip (follow-up) sorusudur. AÅŸaÄŸÄ±daki konuÅŸma geÃ§miÅŸini ve listelenen kampanyalarÄ± inceleyerek, "
    "kullanÄ±cÄ±nÄ±n hangi kampanya hakkÄ±nda detay istediÄŸini belirle ve sadece o kampanyanÄ±n detaylarÄ±nÄ± ver."
)

llm = ChatOpenAI(model_name="gpt-4", temperature=0, system_prompt=system_prompt)
qa_chain = RetrievalQA.from_chain_type(llm=llm, retriever=retriever)

# 6ï¸âƒ£ KonuÅŸma HafÄ±zasÄ± ve Global Durum DeÄŸiÅŸkenleri
memory = ConversationBufferMemory(memory_key="chat_history", return_messages=True)
last_retrieved_campaigns = []   # Son sorgudan dÃ¶nen kampanyalarÄ±n listesini saklar
follow_up_count = 0              # Takip sorgularÄ± iÃ§in sayacÄ± tutar

# 7ï¸âƒ£ Yeni Kampanya SorgularÄ±nÄ± DoÄŸal Dil ile Tespit Eden Fonksiyon
def detect_new_campaign(user_input: str):
    """
    EÄŸer sorguda doÄŸrudan kampanya kodu geÃ§miyorsa,
    vector store Ã¼zerinden ilgili kampanyalarÄ± getirir.
    
    - EÄŸer tek bir kampanya bulunursa, kampanyanÄ±n contentâ€™i ve kullanÄ±cÄ±nÄ±n sorusu ile LLM'den yanÄ±t alÄ±nÄ±r.
    - EÄŸer birden fazla kampanya bulunursa, TOP_N kadar sonuÃ§ liste halinde sunulur.
    """
    global last_retrieved_campaigns
    if re.search(r"KAMP\d{3}", user_input, re.IGNORECASE):
        return None  # Sorguda aÃ§Ä±k kampanya kodu varsa bu fonksiyon devreye girmez.

    retrieved_docs = retriever.get_relevant_documents(user_input)
    if not retrieved_docs:
        return "ÃœzgÃ¼nÃ¼m, sorgunuza uygun kampanya bulunamadÄ±."
    
    last_retrieved_campaigns = retrieved_docs

    if len(retrieved_docs) == 1:
        doc = retrieved_docs[0]
        response = qa_chain.run(
            f"{system_prompt}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {doc.page_content}"
        )
        return response
    else:
        # Birden fazla kampanya bulunduÄŸunda, TOP_N kadar sonuÃ§ liste halinde sunulur.
        response_lines = ["Ä°lgili kampanyalar:"]
        for i, doc in enumerate(retrieved_docs[:TOP_N], start=1):
            title = doc.page_content.split(":")[0].strip()
            code = doc.metadata.get("code", "Bilinmiyor")
            response_lines.append(f"{i}. {code}: {title}")
        return "\n".join(response_lines)

# 8ï¸âƒ£ KullanÄ±cÄ± Girdilerini Ä°ÅŸleyen Fonksiyon
def chat_with_bot(user_input: str):
    global last_retrieved_campaigns, follow_up_count
    try:
        logger.info(f"KullanÄ±cÄ± giriÅŸi: {user_input}")
        chat_history = memory.load_memory_variables({})["chat_history"]

        # (A) EÄŸer sorguda aÃ§Ä±kÃ§a kampanya kodu (Ã¶rn. "KAMP001") varsa:
        code_match = re.search(r"(KAMP\d{3})", user_input, re.IGNORECASE)
        if code_match:
            campaign_code = code_match.group(1).upper()
            selected_doc = next((doc for doc in docs if doc.metadata.get("code", "").upper() == campaign_code), None)
            if selected_doc:
                # Yeni kampanya sorgusu olduÄŸundan, global liste ve (opsiyonel) geÃ§miÅŸ temizlenir.
                last_retrieved_campaigns = [selected_doc]
                follow_up_count = 0
                memory.clear()  # KonuÅŸma geÃ§miÅŸini temizle
                # KampanyanÄ±n contentâ€™i ve kullanÄ±cÄ±nÄ±n sorusu ile LLM'den yanÄ±t alÄ±nÄ±r.
                response = qa_chain.run(
                    f"{system_prompt}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {selected_doc.page_content}"
                )
                memory.save_context({"input": user_input}, {"output": response})
                return response
            else:
                return "Belirtilen kampanya bulunamadÄ±."

        # (B) EÄŸer daha Ã¶nceki sorgudan dÃ¶nen kampanya listesi boÅŸsa, yeni sorgu olarak ele al:
        if not last_retrieved_campaigns:
            new_campaign_response = detect_new_campaign(user_input)
            memory.save_context({"input": user_input}, {"output": new_campaign_response})
            return new_campaign_response

        # (C) Gelen sorgu bir takip (follow-up) sorgusuyse:
        # EÄŸer takip sorgularÄ±nÄ±n sayÄ±sÄ± maksimum deÄŸeri aÅŸtÄ±ysa:
        if follow_up_count >= MAX_FOLLOW_UP:
            # Maksimum takip sayÄ±sÄ±na ulaÅŸÄ±ldÄ±ÄŸÄ±nda, kullanÄ±cÄ±ya yeni kampanya sorgusu yapmasÄ± istenir.
            last_retrieved_campaigns = []
            memory.clear()  # KonuÅŸma geÃ§miÅŸini temizle
            follow_up_count = 0
            return "Maksimum takip soru sÄ±nÄ±rÄ±na ulaÅŸÄ±ldÄ±. LÃ¼tfen yeni kampanya sorgusu yapÄ±nÄ±z."

        # Takip sorgusunda, LLMâ€™den Ã¶nceki listelenen kampanyalar ve konuÅŸma geÃ§miÅŸine dayanarak,
        # kullanÄ±cÄ±nÄ±n hangi kampanyaya atÄ±fta bulunduÄŸunu belirlemesi istenir.
        campaigns_context = "\n".join(
            f"{doc.metadata.get('code','Bilinmiyor')}: {doc.page_content}"
            for doc in last_retrieved_campaigns
        )
        determination_prompt = (
            f"AÅŸaÄŸÄ±daki listelenen kampanyalar iÃ§erisinden, kullanÄ±cÄ±nÄ±n aÅŸaÄŸÄ±daki sorgusuyla en Ã§ok hangi kampanyaya atÄ±fta bulunduÄŸunu belirle. "
            f"EÄŸer sorgu, listelenen kampanyalarla ilgili deÄŸilse, sadece 'yeni kampanya' yaz.\n\n"
            f"Listelenen Kampanyalar:\n{campaigns_context}\n\n"
            f"KullanÄ±cÄ±nÄ±n Sorgusu: {user_input}\n\n"
            f"YanÄ±t (sadece ilgili kampanya kodunu ya da 'yeni kampanya' ifadesini ver): "
        )
        determination = llm.run(determination_prompt).strip().lower()
        logger.info(f"Determination: {determination}")

        # EÄŸer LLM yanÄ±tÄ±nda "yeni kampanya" ifadesi geÃ§iyorsa:
        if "yeni kampanya" in determination:
            last_retrieved_campaigns = []
            memory.clear()  # KonuÅŸma geÃ§miÅŸini temizle
            follow_up_count = 0
            new_campaign_response = detect_new_campaign(user_input)
            memory.save_context({"input": user_input}, {"output": new_campaign_response})
            return new_campaign_response
        else:
            # LLM yanÄ±tÄ±ndan tespit edilen kampanya kodunu kullanarak ilgili kampanyayÄ± seÃ§elim.
            campaign_code_match = re.search(r"(KAMP\d{3})", determination, re.IGNORECASE)
            if campaign_code_match:
                campaign_code = campaign_code_match.group(1).upper()
                selected_doc = next((doc for doc in last_retrieved_campaigns if doc.metadata.get("code", "").upper() == campaign_code), None)
                if not selected_doc:
                    return "Listede belirtilen kampanya bulunamadÄ±."
            else:
                return "LÃ¼tfen hangi kampanyadan bahsettiÄŸinizi netleÅŸtiriniz."
            
            follow_up_count += 1
            # KampanyanÄ±n contentâ€™i ve kullanÄ±cÄ±nÄ±n sorusu ile LLMâ€™den yardÄ±m alÄ±nÄ±r, son yanÄ±t ekrana basÄ±lÄ±r.
            response = qa_chain.run(
                f"{follow_up_prompt}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {selected_doc.page_content}\nKonuÅŸma GeÃ§miÅŸi:\n{chat_history}"
            )
            memory.save_context({"input": user_input}, {"output": response})
            return response

    except Exception as e:
        logger.error(f"Chat iÅŸleminde hata: {e}")
        return "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."

# 9ï¸âƒ£ Streamlit ArayÃ¼zÃ¼
st.title("ğŸ“¢ Reklam Kampanya Chatbotu")
st.write("SorularÄ±nÄ±zÄ± sorun, kampanyalar hakkÄ±nda bilgi alÄ±n!")

user_input = st.text_input("MesajÄ±nÄ±zÄ± girin:")
if st.button("GÃ¶nder"):
    if user_input:
        response = chat_with_bot(user_input)
        st.write(response)





----------------------------------------------------------------------------------------------------

# LOG LU YAPI



import streamlit as st
import logging
import os
import re
import pandas as pd
from datetime import datetime
from langchain.chat_models import ChatOpenAI
from langchain.chains import RetrievalQA
from langchain.memory import ConversationBufferMemory
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Chroma
from langchain.docstore.document import Document

# 1ï¸âƒ£ Logger Ayarla
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# 2ï¸âƒ£ OpenAI API AnahtarÄ± TanÄ±mla
os.environ["OPENAI_API_KEY"] = "your_api_key_here"  # API anahtarÄ±nÄ±zÄ± buraya girin

# 3ï¸âƒ£ Ã–rnek Kampanya Verileri
campaigns = [
    {"code": "KAMP001", "title": "Migros Ä°ndirim KampanyasÄ±", "content": "Migros marketlerinde %20 indirim! 1-10 Åubat arasÄ±nda geÃ§erlidir.", "start_date": "01-02-2024", "end_date": "10-02-2024"},
    {"code": "KAMP002", "title": "Beyaz EÅŸya KampanyasÄ±", "content": "Beyaz eÅŸyalar 15 Mart'a kadar Ã¶zel fiyatlarla!", "start_date": "01-03-2024", "end_date": "15-03-2024"},
    {"code": "KAMP003", "title": "Giyim Sezon Sonu Ä°ndirimi", "content": "TÃ¼m giyim Ã¼rÃ¼nlerinde %30 indirim!", "start_date": "01-04-2024", "end_date": "30-04-2024"}
]

# Parametrik olarak top_n deÄŸeri (ÅŸu anda 3 olarak ayarlandÄ±)
TOP_N = 3

# Takip sorgularÄ± iÃ§in maksimum sayÄ± (Ã¶rneÄŸin 5)
MAX_FOLLOW_UP = 5

# 4ï¸âƒ£ OpenAI Embeddings kullanarak ChromaDB oluÅŸtur ve doldur
embeddings = OpenAIEmbeddings()
vector_store = Chroma(embedding_function=embeddings)
docs = [
    Document(
        page_content=f"{c['title']}: {c['content']} (GeÃ§erlilik: {c['start_date']} - {c['end_date']})",
        metadata={"code": c["code"]}
    )
    for c in campaigns
]
vector_store.add_documents(docs)
retriever = vector_store.as_retriever(search_kwargs={"k": TOP_N})

# 5ï¸âƒ£ LLM Modeli ve Prompt AyarlarÄ±
system_prompt = "Sen bir reklam kampanya asistanÄ±sÄ±n. KullanÄ±cÄ±ya kampanyalar hakkÄ±nda bilgi ver, yanÄ±tlarÄ±nÄ± sadece kampanya metinlerine dayandÄ±r."
follow_up_prompt = (
    "Bu bir takip (follow-up) sorusudur. AÅŸaÄŸÄ±daki konuÅŸma geÃ§miÅŸini ve listelenen kampanyalarÄ± inceleyerek, "
    "kullanÄ±cÄ±nÄ±n hangi kampanya hakkÄ±nda detay istediÄŸini belirle ve sadece o kampanyanÄ±n detaylarÄ±nÄ± ver."
)

llm = ChatOpenAI(model_name="gpt-4", temperature=0, system_prompt=system_prompt)
qa_chain = RetrievalQA.from_chain_type(llm=llm, retriever=retriever)

# 6ï¸âƒ£ KonuÅŸma HafÄ±zasÄ± ve Global Durum DeÄŸiÅŸkenleri
memory = ConversationBufferMemory(memory_key="chat_history", return_messages=True)

# Global kampanya listesi ve takip sayÄ±sÄ±
last_retrieved_campaigns = []   # Son sorgudan dÃ¶nen kampanyalarÄ±n listesini saklar
follow_up_count = 0              # Takip sorgularÄ± iÃ§in sayaÃ§

# Session yÃ¶netimi iÃ§in: kampanya kodu ve session id bilgileri
if "current_campaign_code" not in st.session_state:
    st.session_state["current_campaign_code"] = None
if "session_id" not in st.session_state:
    st.session_state["session_id"] = 0
if "session_counter" not in st.session_state:
    st.session_state["session_counter"] = 0

# Excel loglarÄ±nÄ± tutmak iÃ§in st.session_state kullanÄ±yoruz
if "chat_logs" not in st.session_state:
    st.session_state["chat_logs"] = []

def log_conversation(user_input: str, bot_response: str, campaign_code: str):
    """Her etkileÅŸimi st.session_state Ã¼zerinden kaydeder ve Excel dosyasÄ±na yazar."""
    log_entry = {
        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "session_id": st.session_state["session_id"],
        "campaign_code": campaign_code,
        "user_input": user_input,
        "bot_response": bot_response
    }
    st.session_state["chat_logs"].append(log_entry)
    # Pandas DataFrame'e Ã§evirip Excel dosyasÄ±na yazalÄ±m (her mesaj sonrasÄ± gÃ¼ncelleme)
    df = pd.DataFrame(st.session_state["chat_logs"])
    df.to_excel("chat_logs.xlsx", index=False)

def update_session(campaign_code: str):
    """
    Yeni kampanya kodu geldiyse session id gÃ¼ncellenir, 
    aynÄ± kampanya kodu devam ediyorsa aynÄ± session id kullanÄ±lÄ±r.
    """
    if st.session_state["current_campaign_code"] is None:
        st.session_state["current_campaign_code"] = campaign_code
        st.session_state["session_counter"] = 1
        st.session_state["session_id"] = 1
    elif st.session_state["current_campaign_code"] != campaign_code:
        st.session_state["session_counter"] += 1
        st.session_state["current_campaign_code"] = campaign_code
        st.session_state["session_id"] = st.session_state["session_counter"]
    # EÄŸer kampanya kodu aynÄ± ise, session_id deÄŸiÅŸmeden kalÄ±r.

# 7ï¸âƒ£ Yeni Kampanya SorgularÄ±nÄ± DoÄŸal Dil ile Tespit Eden Fonksiyon
def detect_new_campaign(user_input: str):
    """
    EÄŸer sorguda doÄŸrudan kampanya kodu geÃ§miyorsa,
    vector store Ã¼zerinden ilgili kampanyalarÄ± getirir.
    
    - EÄŸer tek bir kampanya bulunursa, kampanyanÄ±n contentâ€™i ve kullanÄ±cÄ±nÄ±n sorusu ile LLM'den yanÄ±t alÄ±nÄ±r.
    - EÄŸer birden fazla kampanya bulunursa, TOP_N kadar sonuÃ§ liste halinde sunulur.
    """
    global last_retrieved_campaigns
    if re.search(r"KAMP\d{3}", user_input, re.IGNORECASE):
        return None  # Sorguda aÃ§Ä±k kampanya kodu varsa bu fonksiyon devreye girmez.

    retrieved_docs = retriever.get_relevant_documents(user_input)
    if not retrieved_docs:
        return "ÃœzgÃ¼nÃ¼m, sorgunuza uygun kampanya bulunamadÄ±."
    
    last_retrieved_campaigns = retrieved_docs

    # EÄŸer sadece 1 kampanya bulunduysa, session gÃ¼ncellemesi yapalÄ±m.
    if len(retrieved_docs) == 1:
        doc = retrieved_docs[0]
        campaign_code = doc.metadata.get("code", "").upper()
        update_session(campaign_code)
        response = qa_chain.run(
            f"{system_prompt}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {doc.page_content}"
        )
        return response
    else:
        # Birden fazla kampanya bulunursa, TOP_N kadar sonuÃ§ liste halinde sunulur.
        response_lines = ["Ä°lgili kampanyalar:"]
        for i, doc in enumerate(retrieved_docs[:TOP_N], start=1):
            title = doc.page_content.split(":")[0].strip()
            code = doc.metadata.get("code", "Bilinmiyor")
            response_lines.append(f"{i}. {code}: {title}")
        return "\n".join(response_lines)

# 8ï¸âƒ£ KullanÄ±cÄ± Girdilerini Ä°ÅŸleyen Fonksiyon
def chat_with_bot(user_input: str):
    global last_retrieved_campaigns, follow_up_count
    try:
        logger.info(f"KullanÄ±cÄ± giriÅŸi: {user_input}")
        chat_history = memory.load_memory_variables({})["chat_history"]

        # (A) Sorguda aÃ§Ä±kÃ§a kampanya kodu varsa:
        code_match = re.search(r"(KAMP\d{3})", user_input, re.IGNORECASE)
        if code_match:
            campaign_code = code_match.group(1).upper()
            update_session(campaign_code)
            selected_doc = next((doc for doc in docs if doc.metadata.get("code", "").upper() == campaign_code), None)
            if selected_doc:
                last_retrieved_campaigns = [selected_doc]
                follow_up_count = 0
                memory.clear()  # KonuÅŸma geÃ§miÅŸini temizle
                # KampanyanÄ±n contentâ€™i ve kullanÄ±cÄ±nÄ±n sorusu ile LLMâ€™den yanÄ±t alÄ±nÄ±r.
                response = qa_chain.run(
                    f"{system_prompt}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {selected_doc.page_content}"
                )
                log_conversation(user_input, response, campaign_code)
                memory.save_context({"input": user_input}, {"output": response})
                return response
            else:
                return "Belirtilen kampanya bulunamadÄ±."

        # (B) EÄŸer Ã¶nceki kampanya listesi boÅŸsa, yeni sorgu olarak ele al:
        if not last_retrieved_campaigns:
            new_campaign_response = detect_new_campaign(user_input)
            # EÄŸer tek kampanya bulunduysa, session bilgileri detect_new_campaign iÃ§inde gÃ¼ncellenecektir.
            # Kampanya kodÄ±nÄ±, global listeden (varsa) alalÄ±m.
            campaign_code = last_retrieved_campaigns[0].metadata.get("code", "").upper() if last_retrieved_campaigns else ""
            log_conversation(user_input, new_campaign_response, campaign_code)
            memory.save_context({"input": user_input}, {"output": new_campaign_response})
            return new_campaign_response

        # (C) Gelen sorgu bir takip (follow-up) sorgusuysa:
        if follow_up_count >= MAX_FOLLOW_UP:
            last_retrieved_campaigns = []
            memory.clear()  # KonuÅŸma geÃ§miÅŸini temizle
            follow_up_count = 0
            return "Maksimum takip soru sÄ±nÄ±rÄ±na ulaÅŸÄ±ldÄ±. LÃ¼tfen yeni kampanya sorgusu yapÄ±nÄ±z."

        # Takip sorgusunda, LLMâ€™den Ã¶nceki listelenen kampanyalar ve konuÅŸma geÃ§miÅŸi Ã¼zerinden hangi kampanyaya atÄ±fta bulunduÄŸunu belirlemesi istenir.
        campaigns_context = "\n".join(
            f"{doc.metadata.get('code','Bilinmiyor')}: {doc.page_content}"
            for doc in last_retrieved_campaigns
        )
        determination_prompt = (
            f"AÅŸaÄŸÄ±daki listelenen kampanyalar iÃ§erisinden, kullanÄ±cÄ±nÄ±n aÅŸaÄŸÄ±daki sorgusuyla en Ã§ok hangi kampanyaya atÄ±fta bulunduÄŸunu belirle. "
            f"EÄŸer sorgu, listelenen kampanyalarla ilgili deÄŸilse, sadece 'yeni kampanya' yaz.\n\n"
            f"Listelenen Kampanyalar:\n{campaigns_context}\n\n"
            f"KullanÄ±cÄ±nÄ±n Sorgusu: {user_input}\n\n"
            f"YanÄ±t (sadece ilgili kampanya kodunu ya da 'yeni kampanya' ifadesini ver): "
        )
        determination = llm.run(determination_prompt).strip().lower()
        logger.info(f"Determination: {determination}")

        if "yeni kampanya" in determination:
            last_retrieved_campaigns = []
            memory.clear()  # KonuÅŸma geÃ§miÅŸini temizle
            follow_up_count = 0
            new_campaign_response = detect_new_campaign(user_input)
            campaign_code = last_retrieved_campaigns[0].metadata.get("code", "").upper() if last_retrieved_campaigns else ""
            log_conversation(user_input, new_campaign_response, campaign_code)
            memory.save_context({"input": user_input}, {"output": new_campaign_response})
            return new_campaign_response
        else:
            campaign_code_match = re.search(r"(KAMP\d{3})", determination, re.IGNORECASE)
            if campaign_code_match:
                campaign_code = campaign_code_match.group(1).upper()
                selected_doc = next((doc for doc in last_retrieved_campaigns if doc.metadata.get("code", "").upper() == campaign_code), None)
                if not selected_doc:
                    return "Listede belirtilen kampanya bulunamadÄ±."
                update_session(campaign_code)
            else:
                return "LÃ¼tfen hangi kampanyadan bahsettiÄŸinizi netleÅŸtiriniz."
            
            follow_up_count += 1
            response = qa_chain.run(
                f"{follow_up_prompt}\nKullanÄ±cÄ±: {user_input}\nBu kampanya hakkÄ±nda: {selected_doc.page_content}\nKonuÅŸma GeÃ§miÅŸi:\n{chat_history}"
            )
            log_conversation(user_input, response, campaign_code)
            memory.save_context({"input": user_input}, {"output": response})
            return response

    except Exception as e:
        logger.error(f"Chat iÅŸleminde hata: {e}")
        return "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."

# 9ï¸âƒ£ Streamlit ArayÃ¼zÃ¼
st.title("ğŸ“¢ Reklam Kampanya Chatbotu")
st.write("SorularÄ±nÄ±zÄ± sorun, kampanyalar hakkÄ±nda bilgi alÄ±n!")
st.markdown("---")

# Sohbet geÃ§miÅŸini gÃ¶stermek iÃ§in basit bir alan
if "conversation" not in st.session_state:
    st.session_state["conversation"] = []

user_input = st.text_input("MesajÄ±nÄ±zÄ± girin:")

if st.button("GÃ¶nder"):
    if user_input:
        bot_response = chat_with_bot(user_input)
        # KonuÅŸma geÃ§miÅŸini gÃ¼ncelleyelim (sadece metin olarak)
        st.session_state["conversation"].append(("KullanÄ±cÄ±", user_input))
        st.session_state["conversation"].append(("Bot", bot_response))
        # Sohbet geÃ§miÅŸini ekranda gÃ¶sterelim
        for speaker, message in st.session_state["conversation"]:
            if speaker == "KullanÄ±cÄ±":
                st.markdown(f"**KullanÄ±cÄ±:** {message}")
            else:
                st.markdown(f"**Bot:** {message}")

